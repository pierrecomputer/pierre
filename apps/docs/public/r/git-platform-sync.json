{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "git-platform-sync",
  "type": "registry:block",
  "title": "Git Platform Sync",
  "description": "A component that implements repo syncing between code.storage and git platforms like GitHub.",
  "dependencies": [
    "@pierre/sync-ui-core",
    "@pierre/sync-ui-hooks"
  ],
  "registryDependencies": [
    "button",
    "command",
    "field",
    "input",
    "popover",
    "select",
    "tooltip"
  ],
  "files": [
    {
      "path": "registry/new-york/blocks/git-platform-sync/git-platform-sync.tsx",
      "content": "import { Button } from '@/components/ui/button';\nimport { Field, FieldLabel } from '@/components/ui/field';\nimport { Input } from '@/components/ui/input';\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from '@/components/ui/popover';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from '@/components/ui/tooltip';\nimport { cn } from '@/lib/utils';\nimport * as PopoverPrimitive from '@radix-ui/react-popover';\nimport { AlertCircle, BookOpen, ChevronDown, Loader2 } from 'lucide-react';\nimport { useCallback, useEffect, useMemo, useState } from 'react';\n\nimport { ComboBox } from './combobox';\nimport {\n  type GitHubConnectionStatus,\n  useGitHubAppConnection,\n} from './github/github-app-connect';\nimport { GitHubIcon } from './github/icon';\nimport { generateOwnerOptions, useOwners } from './github/owners';\n\n// TODO: determine if this is the canonical way to import other components inside of a block\n\nexport type Step = 'welcome' | 'create' | 'manage';\n\nexport type RepositoryData = {\n  /**\n   * @description The owner of the repository, also referred to as the 'scope' - usually\n   * the username of the user or an organization they belong to.\n   */\n  owner?: string;\n  /**\n   * @description The name of the repository, this is a 'slug' style name.\n   */\n  name?: string;\n  /**\n   * @description The branch of the repository, this is the branch that will be used to sync\n   */\n  branch?: string;\n};\n\nexport type GitPlatformSyncStatus =\n  | 'disconnected'\n  | 'connected'\n  | 'connected-syncing'\n  | 'connected-warning';\n\n/**\n * @description Platforms that code.storage supports\n */\nexport type SupportedGitPlatform = 'github';\nexport type PlatformConfig_GitHub = {\n  platform: 'github';\n  slug: string;\n  redirectUrl?: string;\n};\n// Currently only github configs are allowed, but in the future more\n// may be supported\nexport type PlatformConfigObject = PlatformConfig_GitHub;\n\nexport type GitPlatformSyncProps = {\n  /**\n   * @description List of supported platforms that you want to offer to the user. We recommend\n   * not setting this until we support more platforms.\n   */\n  platforms: PlatformConfigObject[];\n\n  /**\n   * @default 'icon-only'\n   * @description Variant display of the button that opens the sync popover. The\n   * `icon-grow` variant will appear as the `icon` variant until hovered or focused,\n   * and then grow to appear as the `full` variant.\n   */\n  variant?: 'icon-only' | 'icon-grow' | 'full';\n\n  /**\n   * @default true\n   * @description Whether to show the sync indicator in the button, e.g. the little colored dot\n   */\n  showSyncIndicator?: boolean;\n\n  /**\n   * @default 'end'\n   * @description The alignment of the popover content\n   */\n  align?: React.ComponentProps<typeof PopoverContent>['align'];\n\n  /**\n   * @default 'auto'\n   * @description This controls the status dot that appears in the button. If `auto` is set, then\n   * the component will determine either `disconnected` or `connected`. However, an implementor may\n   * choose to override this as `connected-syncing` or `connected-warning`. Note that the component\n   * will not verify that the status is valid, it will faithfully render the status you provide.\n   */\n  status?: 'auto' | GitPlatformSyncStatus;\n\n  /**\n   * @description Control the open state of the popover\n   */\n  open?: boolean;\n\n  /**\n   * @description This directly sets the name of the repository that will be created. Setting this\n   * will take precedence over the `defaultName` option. Users will not be able to change from this\n   * name.\n   */\n  repoName?: string;\n\n  /**\n   * @description If you'd like to suggest a name for the repository, but allow the user to customize it,\n   * this is the initial value of the repository name field. This will be ignored if the `name` option is\n   * set.\n   */\n  repoDefaultName?: string;\n\n  /**\n   * @default 'unique-repo-name…'\n   * @description The placeholder text for the repository name field. This will be invisible if the `name`\n   * or `defaultName` option is set, but if the user erases the defaultName it will be shown.\n   */\n  repoNamePlaceholder?: string;\n\n  /**\n   * @default 'main'\n   * @description The branch that will be used to sync within the repository. `main` is used if this is not\n   * provided.\n   */\n  repoDefaultBranch?: string;\n\n  /**\n   * @description Callback for controlled usage of the the repository name input. Fires\n   * the same as the 'onChange' event of the input.\n   */\n  onRepoNameChange?: (repoName: string) => void;\n\n  /**\n   * @description callback for the change event of the repo owner combobox. Since this\n   * input cannot be controlled, this callback is just for being informed of changes.\n   */\n  onOwnerChange?: (owner: string) => void;\n\n  /**\n   * @description Callback when a user clicks the 'Create Repository' button with valid\n   * data selected. This is where you will hook into the the code storage endpoints in your app.\n   */\n  onRepoCreateAction?: (repoData: RepositoryData) => void;\n\n  /**\n   *\n   * @description Callback when the user clicks the 'Help me get started' button. If this callback is\n   * not provided, the 'Help me get started' button will not be shown.\n   */\n  onHelpAction?: () => void;\n\n  /**\n   * @description Callback when the popover is opened.\n   */\n  onOpenChange?: (isOpen: boolean) => void;\n\n  /**\n   * @deprecated Internal use only, not guaranteed to be supported in the future\n   * @description The container to render the popover portal in, only used for docs. This requires\n   * modifying the shadcn Popover component to accept a container prop for the portal\n   */\n  __container?: React.ComponentProps<\n    typeof PopoverPrimitive.Portal\n  >['container'];\n};\n\nexport function GitPlatformSync({\n  platforms,\n  variant = 'icon-only',\n  align = 'end',\n  status: statusProp = 'auto',\n  repoName,\n  repoDefaultName,\n  repoNamePlaceholder,\n  repoDefaultBranch = 'main',\n  onHelpAction,\n  onRepoCreateAction,\n  onOpenChange,\n  onRepoNameChange,\n  onOwnerChange,\n  open,\n  __container,\n}: GitPlatformSyncProps) {\n  const [isPopoverOpen, setIsPopoverOpen] = useState(open ?? false);\n  const [isTooltipOpen, setIsTooltipOpen] = useState(false);\n\n  const status = useMemo(() => {\n    if (statusProp === 'auto') {\n      // TODO: when we can determine connected vs disconnected, we should update it here\n      return 'disconnected';\n    }\n    return statusProp;\n  }, [statusProp]);\n\n  // We want to make sure the container internal stuff doesn't blow up anyone's types\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const containerProp: any = __container ? { container: __container } : {};\n\n  let platformName: string | undefined;\n  let platformConfig: PlatformConfigObject | undefined;\n\n  const handleOpenChange = useCallback(\n    (isOpen: boolean) => {\n      setIsPopoverOpen(isOpen);\n      if (isOpen) {\n        onOpenChange?.(true);\n      } else {\n        onOpenChange?.(false);\n      }\n    },\n    [onOpenChange]\n  );\n\n  if (platforms.length === 0) {\n    throw new Error('No platforms provided to GitPlatformSync');\n  }\n\n  if (platforms.length === 1 && platforms[0].platform === 'github') {\n    platformName = 'GitHub';\n    platformConfig = platforms[0];\n  } else {\n    throw new Error(\n      'Currently GitPlatformSync only supports a single GitHub platform'\n    );\n  }\n\n  const {\n    handleConnect,\n    status: connectionStatus,\n    fetchInstallationStatus,\n    destroy: destroyGitHubAppConnection,\n  } = useGitHubAppConnection({\n    slug: platformConfig.slug,\n    redirectUrl: platformConfig.redirectUrl,\n  });\n\n  useEffect(() => {\n    fetchInstallationStatus();\n  }, [fetchInstallationStatus]);\n\n  useEffect(() => {\n    return () => {\n      destroyGitHubAppConnection();\n    };\n  }, [destroyGitHubAppConnection]);\n\n  const labelText = `Sync to ${platformName}`;\n\n  // If we don't have any label inside the button we should set an aria-label\n  // that describes what that button does.\n  const buttonAriaLabelProp =\n    variant === 'icon-only'\n      ? {\n          'aria-label': labelText,\n        }\n      : {};\n\n  const PopoverConductorProps: PopoverConductorProps = {\n    align,\n    __container,\n    onHelpAction,\n    onRepoCreateAction,\n    repoName,\n    repoDefaultName,\n    repoNamePlaceholder,\n    repoDefaultBranch,\n    onRepoNameChange,\n    onOwnerChange,\n    handleConnect,\n    connectionStatus,\n  };\n\n  // TODO: fix full button, and disable tooltip on open popover\n  return (\n    <Popover open={isPopoverOpen} onOpenChange={handleOpenChange}>\n      {variant === 'icon-only' ? (\n        <>\n          <Tooltip\n            open={isPopoverOpen ? false : isTooltipOpen}\n            onOpenChange={setIsTooltipOpen}\n            delayDuration={800}\n          >\n            <TooltipTrigger asChild>\n              <PopoverTrigger asChild>\n                <BaseSyncButton {...buttonAriaLabelProp} status={status} />\n              </PopoverTrigger>\n            </TooltipTrigger>\n            <TooltipContent {...containerProp}>{labelText}</TooltipContent>\n          </Tooltip>\n          <PopoverConductor {...PopoverConductorProps} />\n        </>\n      ) : (\n        <>\n          <PopoverTrigger asChild>\n            <BaseSyncButton\n              {...buttonAriaLabelProp}\n              className=\"gap-0\"\n              status={status}\n            >\n              <span\n                className={cn(\n                  'justify-between items-center gap-1.5 text-foreground transition-width delay-200 group-focus:delay-0 duration-150 ease-in-out overflow-hidden inline-flex select-none',\n                  variant === 'icon-grow' && !isPopoverOpen\n                    ? 'max-w-0 opacity-0 group-hover:opacity-100 group-hover:max-w-48 group-focus:opacity-100 group-focus:max-w-48 group-focus:pl-1.5 group-focus:-mr-0.5 group-hover:pl-1.5 group-hover:-mr-0.5'\n                    : 'max-w-48 pl-1.5 -mr-0.5 opacity-100'\n                )}\n              >\n                {labelText}\n                <ChevronDown className=\"h-4 w-4 text-muted-foreground transition-colors group-hover:text-foreground mt-0.25\" />\n              </span>\n            </BaseSyncButton>\n          </PopoverTrigger>\n          <PopoverConductor {...PopoverConductorProps} />\n        </>\n      )}\n    </Popover>\n  );\n}\n\nfunction LilDotGuy({ status }: { status?: GitPlatformSyncStatus }) {\n  if (!status || status === 'disconnected') {\n    return null;\n  }\n  return (\n    <div\n      className={cn(\n        'absolute -bottom-0.5 -right-0.5 h-2 w-2 rounded-full border border-background',\n        status === 'connected' && 'bg-green-500',\n        status === 'connected-syncing' && 'bg-yellow-500',\n        status === 'connected-warning' && 'bg-red-500'\n      )}\n    />\n  );\n}\n\nfunction BaseSyncButton({\n  children,\n  className,\n  status,\n  ...props\n}: React.ComponentProps<typeof Button> & {\n  status?: GitPlatformSyncStatus;\n}) {\n  return (\n    <Button\n      variant=\"outline\"\n      className={cn(\n        'group flex justify-between items-center gap-2 text-foreground px-2',\n        className\n      )}\n      {...props}\n    >\n      <div\n        className=\"relative flex justify-center items-center w-4 mx-0.25\"\n        aria-hidden\n      >\n        <GitHubIcon />\n        <LilDotGuy status={status} />\n      </div>\n      {children}\n    </Button>\n  );\n}\n\ntype PopoverConductorProps = Pick<\n  GitPlatformSyncProps,\n  | 'align'\n  | '__container'\n  | 'onHelpAction'\n  | 'onRepoCreateAction'\n  | 'repoName'\n  | 'repoDefaultName'\n  | 'repoNamePlaceholder'\n  | 'repoDefaultBranch'\n  | 'onRepoNameChange'\n  | 'onOwnerChange'\n> & {\n  handleConnect: ({ onSuccess }: { onSuccess?: () => void }) => void;\n  connectionStatus: GitHubConnectionStatus;\n};\n\nfunction PopoverConductor({\n  align,\n  __container,\n  onHelpAction,\n  onRepoCreateAction,\n  onRepoNameChange,\n  onOwnerChange,\n  repoName,\n  repoDefaultName,\n  repoNamePlaceholder,\n  repoDefaultBranch,\n  handleConnect,\n  connectionStatus,\n}: PopoverConductorProps) {\n  const [step, setStep] = useState<Step>('welcome');\n\n  useEffect(() => {\n    if (connectionStatus === 'installed') {\n      setStep('create');\n    }\n  }, [connectionStatus]);\n\n  // We want to make sure the container internal stuff doesn't blow up anyone's types\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const containerProp: any = __container ? { container: __container } : {};\n\n  return (\n    <PopoverContent className=\"w-[400px]\" align={align} {...containerProp}>\n      {step === 'welcome' ? (\n        <StepWelcome\n          // onAppInstalled={() => setStep('create')}\n          onHelpAction={onHelpAction}\n          handleConnect={handleConnect}\n          connectionStatus={connectionStatus}\n        />\n      ) : null}\n      {step === 'create' ? (\n        <StepCreate\n          __container={__container}\n          repoName={repoName}\n          repoDefaultName={repoDefaultName}\n          repoNamePlaceholder={repoNamePlaceholder}\n          repoDefaultBranch={repoDefaultBranch}\n          onRepoNameChange={onRepoNameChange}\n          onRepoCreateAction={onRepoCreateAction}\n          onOwnerChange={onOwnerChange}\n          handleConnect={handleConnect}\n          connectionStatus={connectionStatus}\n        />\n      ) : null}\n    </PopoverContent>\n  );\n}\n\ntype StepWelcomeProps = {\n  onAppInstalled?: () => void;\n  onHelpAction?: () => void;\n  handleConnect: ({ onSuccess }: { onSuccess?: () => void }) => void;\n  connectionStatus: GitHubConnectionStatus;\n};\n\nfunction StepWelcome({\n  onAppInstalled,\n  onHelpAction,\n  connectionStatus,\n  handleConnect,\n}: StepWelcomeProps) {\n  const isPendingConnection = connectionStatus === 'pending';\n  const hasError = connectionStatus === 'error';\n\n  // TODO: remove this\n  if (connectionStatus === 'installed') {\n    console.error(\n      'welcome step rendered with installed status, which shouldnt happen'\n    );\n  }\n\n  return (\n    <>\n      <div className=\"space-y-4\">\n        <div className=\"space-y-2\">\n          <h4 className=\"font-normal leading-none\">Connect to GitHub</h4>\n          <p className=\"text-sm text-muted-foreground\">\n            Sync your changes to GitHub to backup your code at every snapshot by\n            installing our app on your personal account or organization.\n          </p>\n          {hasError ? (\n            <p className=\"text-sm text-red-500\">\n              There was an error connecting to GitHub. Please try again.\n            </p>\n          ) : null}\n        </div>\n        <div className=\"flex flex-col gap-3\">\n          <Button\n            onClick={\n              isPendingConnection\n                ? undefined\n                : () => {\n                    handleConnect({\n                      onSuccess: onAppInstalled,\n                    });\n                  }\n            }\n            size=\"lg\"\n            className={cn(\n              'w-full',\n              isPendingConnection && 'opacity-80 pointer-events-none'\n            )}\n          >\n            <GitHubIcon />{' '}\n            {isPendingConnection\n              ? 'Connecting to GitHub…'\n              : 'Install GitHub App'}\n          </Button>\n          {onHelpAction ? (\n            <Button\n              onClick={onHelpAction}\n              size=\"lg\"\n              variant=\"secondary\"\n              className=\"w-full\"\n            >\n              <BookOpen /> Help me get started\n            </Button>\n          ) : null}\n        </div>\n      </div>\n    </>\n  );\n}\n\ntype StepCreateProps = {\n  onOwnerChange?: (owner: string) => void;\n  onRepoNameChange?: (repoName: string) => void;\n  // onBranchChange?: (branch: string) => void;\n  connectionStatus: GitHubConnectionStatus;\n  onRepoCreateAction?: (repoData: RepositoryData) => void;\n  handleConnect: ({ onSuccess }: { onSuccess?: () => void }) => void;\n  repoName?: string;\n  repoDefaultName?: string;\n  repoNamePlaceholder?: string;\n  repoDefaultBranch?: string;\n  /**\n   * @deprecated Internal use only, not guaranteed to be supported in the future\n   * @description The container to render the popover portal in, only used for docs. This requires\n   * modifying the shadcn Popover component to accept a container prop for the portal\n   */\n  __container?: React.ComponentProps<\n    typeof PopoverPrimitive.Portal\n  >['container'];\n};\n\nfunction StepCreate({\n  onOwnerChange,\n  onRepoNameChange,\n  onRepoCreateAction,\n  handleConnect,\n  repoName,\n  repoDefaultName,\n  repoNamePlaceholder,\n  repoDefaultBranch,\n  __container,\n}: StepCreateProps) {\n  const { owners, status, getOwnerById, refresh } = useOwners();\n  const [selectedOwnerId, setSelectedOwnerId] = useState<string | null>(null);\n\n  // TODO: This is inelegant. Since it'll necessarily need an extra render pass. We could move\n  // to an uncontrolled combobox and compute the value in the single pass, but idk.\n  useEffect(() => {\n    if (owners.length > 0) {\n      setSelectedOwnerId(owners[0]?.id ?? null);\n    }\n  }, [owners]);\n\n  // We want to make sure the container internal stuff doesn't blow up anyone's types\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const containerProp: any = __container ? { __container: __container } : {};\n\n  const repoInputProps: React.ComponentProps<typeof Input> = useMemo(() => {\n    const rip: React.ComponentProps<typeof Input> = {};\n    if (repoName) {\n      rip.defaultValue = repoName;\n    } else if (repoDefaultName) {\n      rip.defaultValue = repoDefaultName;\n    }\n\n    const defaultPlaceholder = 'unique-repo-name…';\n    if (repoNamePlaceholder) {\n      rip.placeholder = repoNamePlaceholder ?? defaultPlaceholder;\n    } else {\n      rip.placeholder = defaultPlaceholder;\n    }\n    return rip;\n  }, [repoName, repoDefaultName, repoNamePlaceholder]);\n\n  const handleSubmit = useCallback(\n    (e: React.FormEvent<HTMLFormElement>) => {\n      e.preventDefault();\n      const formData = new FormData(e.currentTarget);\n      const repoName = formData.get('repo-name') as string;\n      // TODO: show errors in UI\n      if (!selectedOwnerId) {\n        console.warn('no selectedOwnerId');\n        return;\n      }\n\n      const owner = getOwnerById(selectedOwnerId);\n\n      if (!owner) {\n        console.warn('no owner found for selectedOwnerId', selectedOwnerId);\n        return;\n      }\n\n      const ownerLogin = owner.login;\n\n      if (!ownerLogin) {\n        console.warn(\n          'no ownerLogin found for selectedOwnerId',\n          selectedOwnerId,\n          owner\n        );\n        return;\n      }\n\n      if (!onRepoCreateAction) {\n        console.warn('no onRepoCreateAction provided');\n        return;\n      }\n\n      onRepoCreateAction({\n        owner: ownerLogin,\n        name: repoName,\n        branch: repoDefaultBranch,\n      });\n    },\n    [selectedOwnerId, getOwnerById, onRepoCreateAction, repoDefaultBranch]\n  );\n\n  const ownerOptions = useMemo(() => {\n    return generateOwnerOptions(owners);\n  }, [owners]);\n\n  // TODO: the `min-h-[115.25px]` is a hack to make the height of the content consistent\n  // when we're in different states other than the success state. however that won't\n  // be sustainable. Good for now for intent of behavior, but we should get better\n  // halfway states done.\n  // As an idea for the future, if we don't want to render the form without knowing\n  // the underlying data yet, then we could render it transparently in the background just\n  // for sizing and keep it transparent until the data is loaded.\n  return (\n    <>\n      <div className=\"space-y-4\">\n        <div className=\"space-y-2\">\n          <h4 className=\"font-normal leading-none\">Sync to GitHub</h4>\n          <p className=\"text-sm text-muted-foreground\">\n            Create a new repository or choose an existing one to sync your\n            changes. We&apos;ll push changes with each new prompt you send.\n          </p>\n        </div>\n        {status === 'loading' ? (\n          <div className=\"flex justify-center items-center min-h-[115.25px]\">\n            <Loader2 className=\"h-4 w-4 animate-spin\" />\n          </div>\n        ) : null}\n        {status === 'error' ? (\n          <div className=\"flex justify-center items-center\">\n            <AlertCircle className=\"h-4 w-4\" />\n            <p className=\"text-sm text-red-500 min-h-[115.25px]\">\n              Error loading GitHub accounts. Please try again.\n            </p>\n          </div>\n        ) : null}\n        {status === 'success' && owners.length === 0 ? (\n          <div className=\"flex justify-center items-center\">\n            <p className=\"text-sm text-muted-foreground min-h-[115.25px]\">\n              No GitHub accounts found. Please check the app permissions in your\n              GitHub settings.\n            </p>\n          </div>\n        ) : null}\n        {status === 'success' && owners.length > 0 ? (\n          <form onSubmit={handleSubmit}>\n            <div className=\"flex flex-col gap-4 min-h-[115.25px]\">\n              <div className=\"flex flex-row gap-1\">\n                <Field className=\"w-fit flex-shrink-0 max-w-1/2 gap-1\">\n                  <FieldLabel\n                    htmlFor=\"storage-elements-github-owner\"\n                    className=\"font-normal\"\n                  >\n                    Owner\n                  </FieldLabel>\n                  <ComboBox\n                    id=\"storage-elements-github-owner\"\n                    {...containerProp}\n                    className=\"max-w-full\"\n                    value={selectedOwnerId}\n                    onValueChange={(value) => {\n                      console.log('owner value changed', value);\n                      setSelectedOwnerId(value);\n                      onOwnerChange?.(value);\n                    }}\n                    onAddItem={() => {\n                      handleConnect({\n                        onSuccess: () => {\n                          refresh();\n                        },\n                      });\n                    }}\n                    addItemLabel=\"Add GitHub account…\"\n                    options={ownerOptions}\n                  />\n                </Field>\n                <div\n                  aria-hidden\n                  className=\"font-normal self-end py-1 px-1 text-xl text-muted-foreground\"\n                >\n                  /\n                </div>\n                <Field className=\"flex-1 gap-1\">\n                  <FieldLabel\n                    htmlFor=\"storage-elements-github-repo\"\n                    className=\"font-normal\"\n                  >\n                    Repository\n                  </FieldLabel>\n                  <Input\n                    autoFocus\n                    spellCheck={false}\n                    id=\"storage-elements-github-repo\"\n                    name=\"repo-name\"\n                    {...repoInputProps}\n                    onChange={(e) => onRepoNameChange?.(e.target.value)}\n                  />\n                </Field>\n              </div>\n              <Button size=\"lg\" className=\"w-full\" type=\"submit\">\n                Create Repository\n              </Button>\n            </div>\n          </form>\n        ) : null}\n      </div>\n    </>\n  );\n}\n",
      "type": "registry:component"
    }
  ]
}